name: SSH Debug â€” Project Humanity

on:
  workflow_dispatch:

jobs:
  debug-ssh:
    runs-on: ubuntu-24.04
    steps:
      - name: Check if SSH_PRIVATE_KEY secret is set
        run: |
          if [ -z "${SSH_KEY}" ]; then
            echo "ERROR: SSH_PRIVATE_KEY secret is empty or not set."
            exit 1
          else
            echo "SSH_PRIVATE_KEY secret is present."
          fi
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

        - name: Prepare SSH key
          run: |
            mkdir -p ~/.ssh
            cat > ~/.ssh/deploy_key << 'EOF'
        ${{ secrets.SSH_PRIVATE_KEY }}
        EOF
            chmod 600 ~/.ssh/deploy_key

            echo "Key file written. Lines:"
            wc -l ~/.ssh/deploy_key
            echo "First line:"; head -n1 ~/.ssh/deploy_key
            echo "Last line:"; tail -n1 ~/.ssh/deploy_key
      - name: Scan and verify server host key
        run: |
          ssh-keyscan -t rsa "$SSH_HOST" > ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}

      - name: Test SSH connection with verbose debug output
        run: |
          echo "Initiating SSH connection..."
          ssh -i ~/.ssh/deploy_key \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              -o PubkeyAcceptedAlgorithms=+ssh-rsa \
              -o HostKeyAlgorithms=+ssh-rsa \
              -v \
              "$SSH_USER@$SSH_HOST" "echo 'Connection successful'" 2>&1 | \
          grep -E "(debug1:|Authentication|Permission|Disconnect|sign_and_send_pubkey)"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
