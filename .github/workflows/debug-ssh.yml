name: SSH Debug â€” Project Humanity

on:
  workflow_dispatch:

jobs:
  debug-ssh:
    runs-on: ubuntu-24.04
    steps:
      - name: Prepare SSH key securely
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "Key length (lines): $(wc -l < ~/.ssh/deploy_key)"
          echo "First 4 chars: $(head -n1 ~/.ssh/deploy_key | cut -c1-4)"
          echo "Last 4 chars: $(tail -n1 ~/.ssh/deploy_key | rev | cut -c1-4 | rev)"

      - name: Gather server key info
        run: |
          ssh-keyscan -t rsa "$SSH_HOST" > ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/known_hosts

      - name: Test SSH with verbose output
        run: |
          echo "Attempting SSH connection with debug flags..."
          ssh -i ~/.ssh/deploy_key \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              -o PubkeyAcceptedAlgorithms=+ssh-rsa \
              -o HostKeyAlgorithms=+ssh-rsa \
              -v \
              "$SSH_USER@$SSH_HOST" "echo 'SUCCESS: Authenticated'" 2>&1 | \
          grep -E "(debug1:|Authentication|Permission|Disconnect)"
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
